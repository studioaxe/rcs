name: Manual Calendar Sync (Manual Editor)

on:
  workflow_dispatch:
    inputs:
      triggered_by:
        description: 'Quem disparou (manual-editor)'
        required: false
        default: 'manual-editor'
        type: string
      timestamp:
        description: 'Timestamp da requisição'
        required: false
        type: string

jobs:
  manual-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests icalendar python-dotenv pytz

      - name: Setup Git credentials
        env:
          GH_PAT: ${{ secrets.GH_TOKEN }}
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions (Manual)"
          git remote set-url origin https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git
          echo "[OK] Git credentials configured with PAT"

      - name: Step 1/3 - Sincronizar calendarios
        env:
          AIRBNB_ICAL_URL: ${{ secrets.AIRBNB_ICAL_URL }}
          BOOKING_ICAL_URL: ${{ secrets.BOOKING_ICAL_URL }}
          VRBO_ICAL_URL: ${{ secrets.VRBO_ICAL_URL }}
        run: |
          echo "Sincronizando calendarios..."
          python backend/sync.py

      - name: Step 2/3 - Verificar calendarios
        run: |
          echo "Verificando ficheiros..."
          echo ""
          echo "=== Import Calendar ==="
          if [ -f "import_calendar.ics" ]; then
            echo "[OK] import_calendar.ics encontrado"
            wc -l import_calendar.ics
          else
            echo "[INFO] Nenhum import_calendar.ics"
          fi
          echo ""
          echo "=== Master Calendar ==="
          if [ -f "master_calendar.ics" ]; then
            echo "[OK] master_calendar.ics encontrado"
            wc -l master_calendar.ics
          else
            echo "[INFO] Nenhum master_calendar.ics"
          fi
          echo ""
          echo "=== Manual Calendar ==="
          if [ -f "manual_calendar.ics" ]; then
            echo "[OK] manual_calendar.ics encontrado"
            wc -l manual_calendar.ics
          else
            echo "[INFO] Nenhum manual_calendar.ics"
          fi

      - name: Step 3/3 - Commit e push
        run: |
          echo "=== Adicionando ficheiros ==="
          git add -A
          echo ""
          echo "=== Git Status ==="
          git status
          echo ""
          echo "=== Fazendo commit ==="
          if git diff --cached --quiet; then
            echo "[WARNING] Nenhuma mudanca para commit"
          else
            git commit -m "Manual Editor Sync [manual-editor] $(date +'%Y-%m-%d %H:%M:%S')"
            echo "[SUCCESS] Commit realizado"
            echo ""
            echo "=== Fazendo push ==="
            if git push origin main; then
              echo "[SUCCESS] Push realizado com sucesso"
            else
              echo "[ERROR] Push falhou"
              exit 1
            fi
          fi

      - name: Workflow Summary
        run: |
          echo "=== Manual Calendar Sync Completed ==="
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "Triggered by: ${{ github.event.inputs.triggered_by }}"
          echo "===================================="
          echo ""
          echo "[SUCCESS] Sincronizacao manual concluida!"
          echo "Ficheiros atualizados:"
          echo " - import_calendar.ics"
          echo " - master_calendar.ics"
          echo " - manual_calendar.ics (se aplicavel)"
