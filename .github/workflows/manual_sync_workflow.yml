name: ğŸ—“ï¸ Manual Calendar Sync (Manual Editor)

on:
  workflow_dispatch:
    inputs:
      triggered_by:
        description: 'Quem disparou (manual-editor)'
        required: false
        default: 'manual-editor'
        type: string
      timestamp:
        description: 'Timestamp da requisiÃ§Ã£o'
        required: false
        type: string

jobs:
  manual-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests icalendar python-dotenv pytz

      - name: ğŸ” Setup Git credentials
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions (Manual)"

      - name: ğŸ—“ï¸ Step 1/3: Sincronizar calendÃ¡rios (Backend Consolidado)
        run: |
          echo "â³ Sincronizando calendÃ¡rios..."
          # âœ… NOVO: Usar backend consolidado
          python -m backend.sync

      - name: ğŸ“„ Step 2/3: Verificar calendÃ¡rios
        run: |
          echo "â³ Verificando ficheiros..."
          echo ""
          echo "=== Import Calendar ==="
          if [ -f "import_calendar.ics" ]; then
            echo "âœ“ import_calendar.ics encontrado"
            wc -l import_calendar.ics
          else
            echo "â„¹ï¸ Nenhum import_calendar.ics"
          fi
          
          echo ""
          echo "=== Master Calendar ==="
          if [ -f "master_calendar.ics" ]; then
            echo "âœ“ master_calendar.ics encontrado"
            wc -l master_calendar.ics
          else
            echo "â„¹ï¸ Nenhum master_calendar.ics"
          fi
          
          echo ""
          echo "=== Manual Calendar ==="
          if [ -f "manual_calendar.ics" ]; then
            echo "âœ“ manual_calendar.ics encontrado"
            wc -l manual_calendar.ics
          else
            echo "â„¹ï¸ Nenhum manual_calendar.ics"
          fi

      - name: ğŸ“ Step 3/3: Commit e push
        run: |
          echo "=== Adicionando ficheiros ==="
          git add -A
          
          echo ""
          echo "=== Git Status ==="
          git status
          
          echo ""
          echo "=== Fazendo commit ==="
          if git diff --cached --quiet; then
            echo "âš ï¸ Nenhuma mudanÃ§a para commit"
          else
            git commit -m "ğŸ—“ï¸ Manual Editor Sync [manual-editor] $(date +'%Y-%m-%d %H:%M:%S')"
            echo "âœ… Commit realizado"
            
            echo ""
            echo "=== Fazendo push ==="
            git push origin main
            echo "âœ… Push realizado com sucesso"
          fi

      - name: ğŸ“¢ Workflow Summary
        run: |
          echo "=== Manual Calendar Sync Completed ==="
          echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "Triggered by: ${{ github.event.inputs.triggered_by }}"
          echo "===================================="
          echo ""
          echo "âœ… SincronizaÃ§Ã£o manual concluÃ­da!"
          echo "ğŸ“ Ficheiros atualizados:"
          echo "   â€¢ import_calendar.ics"
          echo "   â€¢ master_calendar.ics"
          echo "   â€¢ manual_calendar.ics (se aplicÃ¡vel)"
