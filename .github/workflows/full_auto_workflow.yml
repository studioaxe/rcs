name: Rental Calendar Sync - Full Auto (6h)

on:
  schedule:
    # Executa a cada 6 horas (0:00, 6:00, 12:00, 18:00 UTC)
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch:
    inputs:
      triggered_by:
        description: 'Usuario que disparou a sincronizacao'
        required: false
        default: 'auto'
        type: string
      timestamp:
        description: 'Timestamp da requisicao'
        required: false
        default: ''
        type: string

# ðŸ”‘ PERMISSÃ•ES - FIX PARA ERRO 403
permissions:
  contents: write

jobs:
  trigger-sync:
    runs-on: ubuntu-latest
    name: Trigger Remote Sync via API
    steps:
      - name: ðŸš€ Trigger sync on Render
        run: |
          response=$(curl -s -w "%{http_code}" -X POST \
            -H "X-API-Key: ${{ secrets.API_SECRET_KEY }}" \
            "${{ secrets.RENDER_APP_URL }}/api/sync?source=github-action-scheduled")
          
          http_code=$(tail -n1 <<< "$response")
          body=$(head -n -1 <<< "$response")

          echo "API Response Code: $http_code"
          echo "API Response Body: $body"

          if [ "$http_code" -ne 200 ]; then
            echo "::error::A sincronizaÃ§Ã£o remota falhou com o cÃ³digo de status $http_code"
            exit 1
          fi
          
          echo "âœ… SincronizaÃ§Ã£o remota acionada com sucesso."
